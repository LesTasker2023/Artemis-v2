// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ==========================================
// USER & AUTH
// ==========================================

model User {
  id               String            @id @default(uuid())
  discordId        String?           @unique
  email            String?           @unique
  username         String            @unique
  avatarUrl        String?
  
  // Subscription
  subscriptionTier SubscriptionTier  @default(FREE)
  subscriptionEnds DateTime?
  stripeCustomerId String?           @unique
  
  // Aggregate Stats (denormalized for performance)
  totalPedEarned   Decimal           @default(0) @db.Decimal(12, 2)
  totalKills       Int               @default(0)
  totalSessions    Int               @default(0)
  
  // Privacy
  profileVisibility Visibility       @default(PUBLIC)
  
  // Relations
  sessions         Session[]
  achievements     UserAchievement[]
  follows          Follow[]          @relation("Follower")
  followers        Follow[]          @relation("Following")
  comments         Comment[]
  competitions     CompetitionEntry[]
  createdCompetitions Competition[]
  
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  
  @@index([username])
  @@index([subscriptionTier])
}

enum SubscriptionTier {
  FREE
  PREMIUM
  ELITE
}

enum Visibility {
  PUBLIC
  PRIVATE
  FRIENDS
}

// ==========================================
// SESSIONS (ARTEMIS DATA)
// ==========================================

model Session {
  id                String      @id @default(uuid())
  userId            String
  user              User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // From ARTEMIS
  artemisSessionId  String      @unique
  name              String
  startTime         DateTime
  endTime           DateTime?
  durationSeconds   Int
  
  // Stats (denormalized from events)
  totalKills        Int         @default(0)
  totalDamage       Decimal     @default(0) @db.Decimal(10, 2)
  totalLootValue    Decimal     @default(0) @db.Decimal(10, 4)
  totalAmmoCost     Decimal     @default(0) @db.Decimal(10, 4)
  profit            Decimal     @default(0) @db.Decimal(10, 4)
  profitPerHour     Decimal     @default(0) @db.Decimal(10, 4)
  accuracy          Decimal     @default(0) @db.Decimal(5, 4)
  totalShots        Int         @default(0)
  totalHits         Int         @default(0)
  
  // Loadout
  weaponName        String?
  armorSetName      String?
  ampName           String?
  loadoutId         String?
  
  // GPS Track (JSONB array of {lon, lat, timestamp})
  gpsTrack          Json?
  
  // Platform Features
  visibility        Visibility  @default(PUBLIC)
  viewCount         Int         @default(0)
  likeCount         Int         @default(0)
  featured          Boolean     @default(false)
  
  // Relations
  events            SessionEvent[]
  comments          Comment[]
  
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  
  @@index([userId])
  @@index([profitPerHour(sort: Desc)])
  @@index([profit(sort: Desc)])
  @@index([totalKills(sort: Desc)])
  @@index([createdAt(sort: Desc)])
  @@index([featured])
}

model SessionEvent {
  id          String    @id @default(uuid())
  sessionId   String
  session     Session   @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  eventType   String    // SHOT_FIRED, HIT_REGISTERED, MOB_KILLED, LOOT_RECEIVED, GPS_UPDATE
  timestamp   DateTime
  payload     Json      // Event-specific data
  
  createdAt   DateTime  @default(now())
  
  @@index([sessionId])
  @@index([eventType])
  @@index([timestamp])
}

// ==========================================
// LEADERBOARDS
// ==========================================

model LeaderboardEntry {
  id            String    @id @default(uuid())
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  category      String    // profit_per_hour, efficiency, kills, accuracy, longest_session
  period        Period
  rank          Int
  value         Decimal   @db.Decimal(12, 4)
  metadata      Json?     // Additional context (session ID, weapon used, etc.)
  
  calculatedAt  DateTime  @default(now())
  
  @@unique([userId, category, period])
  @@index([category, period, rank])
  @@index([calculatedAt])
}

enum Period {
  DAILY
  WEEKLY
  MONTHLY
  ALL_TIME
}

// ==========================================
// ACHIEVEMENTS
// ==========================================

model Achievement {
  id                String             @id @default(uuid())
  code              String             @unique
  name              String
  description       String
  iconUrl           String
  tier              AchievementTier
  points            Int
  requirements      Json               // Flexible rules engine
  sortOrder         Int                @default(0)
  
  userAchievements  UserAchievement[]
  
  createdAt         DateTime           @default(now())
  
  @@index([tier])
  @@index([sortOrder])
}

enum AchievementTier {
  BRONZE
  SILVER
  GOLD
  PLATINUM
}

model UserAchievement {
  id             String      @id @default(uuid())
  userId         String
  user           User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievementId  String
  achievement    Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)
  
  earnedAt       DateTime    @default(now())
  progress       Int         @default(100) // For multi-step achievements
  
  @@unique([userId, achievementId])
  @@index([userId])
  @@index([earnedAt])
}

// ==========================================
// COMPETITIONS
// ==========================================

model Competition {
  id                String             @id @default(uuid())
  title             String
  description       String
  rules             Json               // Flexible rules definition
  
  startDate         DateTime
  endDate           DateTime
  
  prizePoolPed      Decimal            @db.Decimal(10, 2)
  entryFeePed       Decimal            @default(0) @db.Decimal(10, 2)
  
  status            CompetitionStatus  @default(UPCOMING)
  category          String             // profit, efficiency, kills, specific_mob
  
  creatorId         String
  creator           User               @relation(fields: [creatorId], references: [id])
  
  featured          Boolean            @default(false)
  
  entries           CompetitionEntry[]
  
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  
  @@index([status])
  @@index([startDate])
  @@index([category])
  @@index([featured])
}

enum CompetitionStatus {
  UPCOMING
  ACTIVE
  ENDED
}

model CompetitionEntry {
  id             String       @id @default(uuid())
  competitionId  String
  competition    Competition  @relation(fields: [competitionId], references: [id], onDelete: Cascade)
  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  sessionIds     String[]     // Array of session UUIDs submitted for this competition
  score          Decimal      @db.Decimal(12, 4)
  rank           Int?
  prizeWon       Decimal?     @db.Decimal(10, 2)
  
  submittedAt    DateTime     @default(now())
  
  @@unique([competitionId, userId])
  @@index([competitionId, score(sort: Desc)])
}

// ==========================================
// SOCIAL FEATURES
// ==========================================

model Comment {
  id          String    @id @default(uuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  targetType  String    // session, event, shop, item, mob
  targetId    String
  
  content     String    @db.Text
  
  parentId    String?
  parent      Comment?  @relation("Replies", fields: [parentId], references: [id], onDelete: Cascade)
  replies     Comment[] @relation("Replies")
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@index([targetType, targetId])
  @@index([userId])
  @@index([createdAt(sort: Desc)])
}

model Follow {
  id          String    @id @default(uuid())
  followerId  String
  follower    User      @relation("Follower", fields: [followerId], references: [id], onDelete: Cascade)
  followingId String
  following   User      @relation("Following", fields: [followingId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime  @default(now())
  
  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
}

// ==========================================
// EVENTS & SHOPS (Migrated from Discord)
// ==========================================

model Event {
  id            String    @id @default(uuid())
  creatorId     String
  creator       User      @relation(fields: [creatorId], references: [id])
  
  title         String
  description   String    @db.Text
  startDate     DateTime
  endDate       DateTime?
  location      String?
  planet        String?
  category      String?
  bannerUrl     String?
  
  status        EventStatus @default(UPCOMING)
  attendeeCount Int       @default(0)
  approved      Boolean   @default(false)
  featured      Boolean   @default(false)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@index([status])
  @@index([startDate])
  @@index([approved])
  @@index([featured])
}

enum EventStatus {
  UPCOMING
  ACTIVE
  COMPLETED
  CANCELLED
}

model Shop {
  id            String    @id @default(uuid())
  ownerId       String
  owner         User      @relation(fields: [ownerId], references: [id])
  
  name          String
  description   String?   @db.Text
  planet        String
  location      String?
  coordinates   Json?     // {lon, lat}
  category      String?
  imageUrl      String?
  contactInfo   String?
  
  verified      Boolean   @default(false)
  featured      Boolean   @default(false)
  
  inventory     ShopInventory[]
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@index([planet])
  @@index([verified])
  @@index([featured])
}

model ShopInventory {
  id          String    @id @default(uuid())
  shopId      String
  shop        Shop      @relation(fields: [shopId], references: [id], onDelete: Cascade)
  
  itemName    String
  quantity    Int       @default(0)
  pricePed    Decimal   @db.Decimal(10, 2)
  inStock     Boolean   @default(true)
  
  updatedAt   DateTime  @updatedAt
  
  @@index([shopId])
  @@index([itemName])
}

// ==========================================
// ITEM & MOB DATABASE
// ==========================================

model Item {
  id            String    @id @default(uuid())
  type          String    // weapon, armor, amp, enhancer, tool
  name          String    @unique
  description   String?   @db.Text
  stats         Json?     // Flexible stats object
  imageUrl      String?
  wikiUrl       String?
  
  // Market data
  averageMarkup Decimal?  @db.Decimal(6, 2)
  
  lastUpdated   DateTime  @updatedAt
  
  @@index([type])
  @@index([name])
}

model Mob {
  id                String    @id @default(uuid())
  name              String    @unique
  species           String?
  maturity          String?
  healthPool        Decimal?  @db.Decimal(10, 2)
  
  // Intelligence data
  averageLoot       Decimal?  @db.Decimal(10, 4)
  averageProfitPerHour Decimal? @db.Decimal(10, 4)
  bestWeaponTypes   String[]
  
  spawnLocations    Json?     // Array of {planet, lon, lat, radius}
  imageUrl          String?
  codexRewards      Json?
  
  lastUpdated       DateTime  @updatedAt
  
  @@index([name])
  @@index([species])
}

model MobIntelligence {
  id                    String    @id @default(uuid())
  mobId                 String
  mob                   Mob       @relation(fields: [mobId], references: [id], onDelete: Cascade)
  period                Period
  
  // Profitability
  avgProfitPerHour      Decimal   @db.Decimal(10, 4)
  avgReturnRate         Decimal   @db.Decimal(6, 4)
  
  // Competition
  activeHuntersCount    Int
  competitionLevel      String    // low, medium, high
  
  // Recommendations (AI-generated)
  bestWeapons           String[]
  bestTimeToHunt        String?
  efficiencyTips        String[]
  
  generatedAt           DateTime  @default(now())
  
  @@unique([mobId, period])
  @@index([mobId])
}
